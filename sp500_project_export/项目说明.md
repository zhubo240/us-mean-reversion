# 标普500均值回归分析项目

## 项目背景

本项目通过分析97年历史数据（1928-2024年），验证均值回归理论：**标普500的长期实际年化复合回报率（CAGR）稳定在6.8%左右**。

### 核心发现

- **理论预期**：标普500长期实际CAGR ≈ 6.8%
- **实际结果**：97年实际实际CAGR = **6.70%**
- **验证结论**：数据与理论高度吻合，均值回归效应显著存在

### 均值回归理论意义

均值回归理论表明，尽管短期内股市波动剧烈，但长期持有资产会收敛到某个相对稳定的回报率水平。这对投资者具有重要启示：
- 短期波动不可避免（1年回报范围：-43.8% ~ +53.6%）
- 长期持有可大幅降低风险（30年回报范围：3.2% ~ 10.3%）
- 时间是最好的风险分散工具

---

## 文件说明

### 代码文件 (code/)

#### sp500_data.py
**核心数据模块**
- 包含1928-2024年标普500年度数据
- 核心数据字段：
  - `年份`（Year）
  - `名义总回报率`（Nominal Total Return）：包含股利再投资
  - `CPI通胀率`（CPI Inflation Rate）：美国消费价格指数
- 数据质量：经过多源验证，与公开历史记录一致
- 用途：所有下游分析的数据源

#### build_analysis.py
**分析计算引擎**
- 主要功能：
  - 实际回报计算：名义回报 ÷ (1 + 通胀率)
  - 累积增长计算：基于年度回报的链式乘积
  - 滚动CAGR计算：采用多时间窗口分析
    - 1年持有期回报
    - 3年CAGR
    - 5年CAGR
    - 10年CAGR
    - 15年CAGR
    - 20年CAGR
    - 30年CAGR
- 输出：`sp500_analysis.json`，包含所有计算结果和统计指标
- 性能：处理97年数据的计算耗时<1秒

#### rebuild_report.py
**HTML报告生成器**
- 功能：生成完整的交互式HTML报告
- 报告结构：13个章节，逻辑递进展开
- 可视化：8个Chart.js交互式图表
  - 名义vs实际增长曲线
  - 滚动CAGR分布
  - 回报分布直方图
  - 持有期与波动关系
  - 等等
- 导航：左侧固定导航栏，支持快速跳转
- 响应式设计：适配不同屏幕尺寸
- 输出：`sp500_mean_reversion.html`（约195KB）

#### sp500_decomposition.py（新增·Phase 3）
**三层回报分解引擎**
- 功能：将 S&P 500 年度回报分解为 盈利增长 + PE 扩张 + 股息率
- 三个层级：
  - Level 1（总量）：S&P 500 整体年度分解
  - Level 2（行业）：11 个 GICS 行业各自分解 + 对总量贡献
  - Level 3（公司）：~500 家成分股个体数据
- 核心恒等式：价格回报 = 盈利增长 × PE 变化
- 验证：Σ公司 = Σ行业 = 总量（最大差异 $0.2M，浮点精度）
- 附加分析：
  - 滚动窗口（5/10/20年）年化分解
  - 均值回归统计（标准差收敛）
  - Top 10 盈利变化/PE 影响公司
- 数据源：Compustat 公司年报（`prcc_f` 价格，非 CRSP RET）
- 分析区间：1985-2024（40年，GICS 覆盖 >93%）
- 输出：`data/sp500_3level_decomposition.json`（6.4MB）
- 复用：`sp500_company_analysis.py` 的数据管道函数

#### sp500_decomposition_report.py（新增·Phase 3）
**分解数据格式化报表**
- 读取 JSON，打印 6 张格式化控制台表格：
  - 表1：年度总量分解（1985-2024）
  - 表2：行业贡献（关键年份 1990/2000/2010/2020/2024）
  - 表3：三层加总验证
  - 表4：滚动窗口分解（5/10/20年）
  - 表5：均值回归统计
  - 表6：Top Contributors

#### sp500_real_returns.py（新增·Phase 2）
**CRSP 市值加权回报计算**
- 功能：用 CRSP 月度数据计算 S&P 500 真实市值加权年回报
- 关键修正：使用年初（前年12月）市值作权重，避免赢家偏差
  - 错误方法（年末市值权重）：17.71%/年 ← 严重高估
  - 正确方法（年初市值权重）：10.58%/年 ← 合理
- 附加：PE 扩张频率分析，验证 EPS 低估假说

#### sp500_industry_analysis.py（新增·Phase 2）
**GICS 行业分析**
- 真实 Compustat GICS 行业代码（替代 French 5行业近似分类）
- 11 个 GICS 行业 1980-2024 的权重、回报、PE 分析
- 关键发现：
  - 信息技术权重：11.8%（1985）→ 29.3%（2024）
  - 跨行业 PE 相关性 0.192（低 → 支持行业轮动机制）
  - 若所有行业 PE 均值回归：S&P 500 PE 从 27.2 降至 20.5（-24.5%）

#### sp500_company_analysis.py（新增·Phase 2）
**公司级别分析基础模块**
- 提供被其他脚本复用的核心函数：
  - `load_csv()`, `safe_float()` — 数据读取
  - `build_permno_to_gvkey()` — PERMNO→GVKEY 映射
  - `build_sp500_by_year()` — 按年构建成分股集合
  - `build_compustat_lookup()` — Compustat 数据索引
- GICS 行业代码字典（10=能源 → 60=房地产）

#### sp500_summary.py（新增·Phase 2）
**快速汇总统计**
- 1962-2024 公司级别 CAGR 8.14% vs Shiller 指数 5.16%
- 差异 = 组合效应（成分股更替带来的增量）

#### inject_expandable.py
**可展开表格注入模块**（早期版本）

#### inject_sections.py
**早期版本脚本**（已由 rebuild_report.py 取代）

#### verify_eps_underestimation.py（新增）
**EPS 低估假说验证脚本**
- 功能：验证市场是否系统性低估 S&P 500 盈利增速
- 方法：
  - 分解历史回报为股息率 + EPS 增长 + PE 变化
  - Gordon 模型反推市场隐含增长预期
  - 对比实际 EPS 增长，检验系统性低估
- 数据：Shiller 历史数据（1928-2024）
- 结论：65% 时段存在低估，平均幅度 1.66%/年

#### corrected_returns.py（新增）
**修正后回报计算脚本**
- 功能：将 EPS 低估修正纳入回报归因
- 输出：修正后的风险溢价分解、$100 投资增长对比、公平定价 PE 估算

### 数据文件 (data/)

#### sp500_3level_decomposition.json（新增·Phase 3）
**三层分解完整数据集**
- 文件大小：6.4MB
- 内容：
  - `metadata`：分析参数
  - `aggregate`：40年年度总量分解（盈利增长/PE扩张/股息率/总回报）
  - `sectors`：~440条行业年度记录（11行业×40年）
  - `companies`：~20,437条公司年度记录
  - `verification`：三层加总验证（差值/回报差）
  - `rolling`：5/10/20年滚动窗口年化分解
  - `mean_reversion`：均值回归统计（标准差/范围/收敛倍数）
  - `top_contributors`：每年Top盈利变化和PE影响公司

#### sp500_industry_analysis.json（新增·Phase 2）
**GICS 行业分析数据**
- 11 个 GICS 行业 1980-2024 的权重、回报、PE 数据

#### sp500_analysis.json
**主分析数据集**
- 文件大小：74KB
- 内容：
  - 年度级别数据：97个年份的名义回报、实际回报、累积增长
  - 滚动CAGR：各时间窗口的回报率统计
  - 汇总统计：均值、中位数、标准差、最小值、最大值、夏普比率等
  - 百分位数：P10, P25, P50, P75, P90等
- 格式：JSON，便于程序读取和可视化

#### industry_data.json
**行业分解数据（98年）**
- 覆盖期间：1927-2024年（共98年）
- 数据来源：
  - 1927-2019年：Kenneth French Data Library（基于CRSP数据）
  - 2020-2024年：根据GICS行业回报率映射到French 5行业分类估算
- 5大行业分类：
  - 消费品（Consumer）
  - 制造业（Manufacturing）
  - 能源（Oil）
  - 金融（Finance）
  - 其他（Other）
- 数据字段：
  - 各行业年度权重（Weight）
  - 行业回报率（Return）
  - 行业对指数的贡献度（Contribution）
- 用途：理解指数组成变化，分析行业轮动效应

#### turnover_data.json
**标普500成分股年度更替数据**
- 覆盖期间：1997-2026年（30年）
- 数据来源：fja05680/sp500 GitHub仓库
- 主要指标：
  - 年度新增成分股数量
  - 年度退出成分股数量
  - 年度更替率（Turnover Rate）
- 洞见：
  - 自1996年以来，共有1194家不同的公司进出标普500
  - 仅29%的公司存活至2024年
  - 年均更替率4.4%
  - 体现了指数的"新陈代谢"特性

#### duration_dist.json
**公司在指数中的存续时间分布**
- 内容：统计公司在标普500中的存续期长度分布
- 用途：分析公司寿命周期，理解指数的动态演进

#### data/crsp_compustat/（新增·Phase 2）
**CRSP/Compustat 原始数据**
- `compustat_annual.csv` — Compustat 公司年报（prcc_f, epspx, dvpsx_f, ni, csho, gsector 等）
- `ccm_link_table.csv` — PERMNO→GVKEY 映射表（含日期有效期和 linkprim 优先级）
- `sp500_constituents.csv` — S&P 500 历史成分股列表（含起止日期）
- `crsp_monthly.csv` — CRSP 月度回报数据（368MB, 515万行, PERMNO/RET/PRC/SHROUT 等）
- 数据来源：闲鱼购买的学术数据集

### 报告文件 (report/)

#### sp500_mean_reversion.html
**最终交互式HTML报告**
- 文件大小：~4.8MB（内嵌所有数据为 JS 常量）
- 报告结构：**5个Part，18+个章节**
  - Part I · 指数层面：核心数据、每年实际回报率、均值回归漏斗、滚动年化、任意入场→2024、$100累积增长
  - Part II · 行业层面：行业权重演变、Top 10 变迁
  - Part III · 公司层面：创造性破坏时间线、年度换手率、公司存活时间分布、1194家公司全景
  - **Part IV · 回报分解（新增）**：年度回报分解、均值回归收敛、行业贡献分解、三层加总验证
  - Part V · 结论：核心机制解析、完整年度数据
- **12+ 个 Chart.js 交互式图表**
- 新增图表说明：
  - 年度回报分解堆叠柱状图（盈利增长+PE扩张+股息，极值截断于±100%）
  - 滚动窗口收敛双图（5/10/20年回报线图 + 波动率柱状图）
  - 行业贡献水平柱状图（带年份选择器下拉框，1985-2024）
  - 三层加总验证数据表
- 左侧固定导航栏 + 深色主题 + 响应式设计

### 对话记录 (conversation/)

#### 对话记录.md
**项目完整对话记录**
- 内容：
  - 项目需求分析讨论
  - 数据来源和验证过程
  - 代码设计和实现思路
  - 结果解读和优化建议
  - 技术问题解决
- 用途：
  - 理解项目演进历程
  - 学习分析思路和方法
  - 作为文档补充材料

#### conversation_raw.jsonl
**原始对话数据**
- 格式：JSONL（JSON Lines），每行一个对话轮次
- 内容：原始的结构化对话数据
- 用途：程序处理和数据分析

---

## 数据来源

### 标普500年度回报数据（1928-2024）
- **来源**：公开历史数据
- **包含内容**：名义总回报率（包含股利再投资）
- **数据质量**：与多个权威来源交叉验证
  - 美国证券交易委员会（SEC）历史数据
  - 学术数据库（JSTOR）
  - 金融数据提供商（Yahoo Finance, Morningstar等）

### 美国CPI通胀数据（1928-2024）
- **来源**：美国劳工统计局（BLS）
- **数据类型**：年度平均消费价格指数
- **精确度**：基于官方统计，具有高度可信性

### 行业数据（1927-2024）

#### 1927-2019年：Kenneth French Data Library
- **机构**：Dartmouth College Tuck School of Business
- **基础数据**：CRSP（Center for Research in Security Prices）
- **行业分类**：French 5因子模型的5行业分类
- **特点**：学术级别的严谨性和权威性

#### 2020-2024年：估算映射
- **方法**：将现代GICS（全球行业分类标准）行业回报映射到French 5行业分类
- **过程**：
  1. 获取GICS 11大行业的年度回报
  2. 根据成分股行业权重，将GICS映射到French 5行业
  3. 计算加权回报率
- **精确度**：在可用数据限制下的最优估算

### 标普500成分股变更数据（1997-2026）
- **来源**：fja05680/sp500 GitHub仓库
- **更新频率**：定期更新至最新年份
- **数据完整性**：覆盖近30年的成分股变更记录
- **应用**：研究指数的动态特性和公司寿命周期

---

## 主要发现

### 1. 回报统计

| 指标 | 名义值 | 实际值 |
|------|-------|-------|
| **97年CAGR** | 9.94% | 6.70% |
| **初始投资** | $1 | $1 |
| **最终价值** | $17,320 | $10,960 |
| **总增长倍数** | 17,320倍 | 10,960倍 |

**解读**：
- 扣除通胀后，标普500的长期实际回报率为6.70%，与理论预期的6.8%非常接近
- 名义回报率与实际回报率的差异（3.24个百分点）完全来自通胀的累积效应
- 这充分验证了均值回归理论的有效性

### 2. 短期波动性

| 持有期 | 最小回报 | 最大回报 | 波动范围 | 标准差 |
|-------|---------|---------|---------|--------|
| **1年** | -43.8% | +53.6% | 97.4% | 20.1% |
| **3年** | -22.7% | +24.1% | 46.8% | 10.5% |
| **5年** | -7.8% | +17.4% | 25.2% | 6.8% |
| **10年** | +2.0% | +14.6% | 12.6% | 3.6% |
| **20年** | +3.8% | +13.1% | 9.3% | 2.2% |
| **30年** | +3.2% | +10.3% | 7.1% | 1.5% |

**核心结论**：
- **短期高波动**：单年回报范围高达97.4个百分点，充分反映股市的短期风险
- **长期收敛**：随着持有期延长，回报范围逐步收窄
- **30年稳定性**：持有30年，回报率稳定在3.2% ~ 10.3%之间，波动仅7.1个百分点
- **时间的力量**：每增加1倍的持有期，波动幅度约下降55%

### 3. 回报分解（新增·Phase 3，CRSP/Compustat 公司级别数据）

| 分解因子 | 年化贡献 |
|---------|---------|
| **盈利增长** | 7.33% |
| **PE 扩张** | 2.71% |
| **股息率** | 2.42% |
| **总回报** | **12.65%** |

- 分析区间：1985-2024（40年），~500家 S&P 500 成分股
- 三层验证：Σ公司 = Σ行业 = 总量（最大差异 $0.2M）
- 均值回归量化：5年窗口标准差 7.77% → 20年窗口 1.89%（收敛 4.1 倍）
- 跨行业 PE 相关性 0.192 → 低相关支持行业轮动作为均值回归机制

### 4. 均值回归特性

**滚动CAGR分布分析**：
- 1年回报的标准差：20.1%
- 10年CAGR的标准差：3.6%
- 30年CAGR的标准差：1.5%

**数学解释**：
```
长期CAGR的波动性 ≈ √(1/n) × 短期波动率
其中 n = 持有年数
```

例如：10年的标准差 ≈ 20.1% × √(1/10) ≈ 6.4%（与实际3.6%接近的下界）

### 4. 成分股更替与指数活力

| 指标 | 数值 |
|------|------|
| **年代覆盖** | 1997-2026（30年） |
| **进出总数** | 1,194家公司 |
| **生存至今** | 29% (345家) |
| **年均更替率** | 4.4% |
| **最高更替年** | ~8% (2020年左右) |

**深层含义**：
- **新陈代谢**：71%的公司最终退出指数，反映了市场的残酷竞争
- **动态演进**：每年平均有4.4%的成分股被替换，指数在不断调整自身结构
- **生存者偏差**：仅有29%的公司能在30年内保持在指数内，说明持续竞争力的稀缺性
- **行业转换**：旧行业公司逐步被新兴行业公司替代，推动指数的结构优化

### 5. 行业轮动

**关键观察**：
- **1927-1970年**：制造业和消费品主导，金融、能源辅助
- **1970-2000年**：金融业崛起，制造业相对衰落
- **2000-2024年**：信息技术（归入其他类）爆发性增长，金融相对衰落
- **最新趋势**（2020-2024）：能源回暖，制造业企稳

**投资启示**：
- 行业权重变化反映经济结构演进
- 指数长期表现来自于新兴产业的补充
- 被动指数投资天然实现了"顺势而为"的行业配置

---

## 技术实现

### 技术栈

| 层级 | 技术 | 用途 |
|------|------|------|
| **数据处理** | Python 3 | 数据清洗、计算、分析 |
| **计算库** | NumPy, Pandas | 向量化计算、数据框操作 |
| **可视化** | Chart.js | 交互式图表渲染 |
| **报告生成** | Jinja2, HTML/CSS | 模板引擎、页面布局 |
| **数据格式** | JSON | 结构化数据交换 |
| **源数据库** | Kenneth French Data Library | 学术级行业数据 |

### 代码流程

```
Phase 1: Shiller 指数级别
  sp500_data.py → build_analysis.py → sp500_analysis.json
  verify_eps_underestimation.py → EPS低估验证
  corrected_returns.py → 修正回报归因

Phase 2: CRSP/Compustat 公司级别
  crsp_monthly.csv → sp500_real_returns.py → CRSP市值加权回报
  compustat_annual.csv + ccm_link_table.csv + sp500_constituents.csv
    → sp500_company_analysis.py → 公司级别基础分析
    → sp500_industry_analysis.py → sp500_industry_analysis.json
    → sp500_summary.py → 快速汇总

Phase 3: 三层分解
  sp500_decomposition.py → sp500_3level_decomposition.json
  sp500_decomposition_report.py → 格式化控制台表格

报告生成:
  所有 JSON + rebuild_report.py → report/sp500_mean_reversion.html
```

### 计算方法

#### 实际回报计算
```python
实际回报率 = (1 + 名义回报率) / (1 + 通胀率) - 1
```

#### CAGR计算
```python
CAGR = (终值 / 初值) ^ (1 / 年数) - 1
```

#### 滚动CAGR（以5年为例）
```
对每个起始年份：
  计算该年起后5年的累积回报
  计算年化复合增长率
结果：形成一个回报率序列
```

---

## 使用指南

### 快速开始

#### 1. 重新生成分析数据
```bash
python code/build_analysis.py
# 输出：data/sp500_analysis.json
```

#### 2. 生成HTML报告
```bash
python code/rebuild_report.py
# 输出：report/sp500_mean_reversion.html
```

#### 3. 增强报告交互
```bash
python code/inject_expandable.py
# 在现有report基础上添加表格展开功能
```

### 文件修改指南

#### 更新源数据
编辑 `code/sp500_data.py`：
- 添加最新年份的回报率和CPI数据
- 确保数据格式一致
- 重新运行 `build_analysis.py`

#### 修改报告结构
编辑 `code/rebuild_report.py`：
- `SECTIONS` 变量：定义报告章节
- `CHARTS` 变量：定义图表配置
- HTML模板：调整样式和布局

#### 更新行业数据
编辑 `data/industry_data.json`：
- 添加最新年份的行业权重和回报率
- 保持JSON格式有效
- 重新生成报告以反映最新数据

---

## 研究价值

### 学术意义

1. **均值回归理论验证**
   - 提供97年的实证支持
   - 量化了不同持有期的收敛速度
   - 为金融学教学提供实际案例

2. **市场有效性研究**
   - 说明市场长期趋向均衡
   - 支持"随机游走"假说
   - 反驳"市场永远正确"的极端观点

3. **行业演进研究**
   - 展示百年经济结构变化
   - 记录产业升级的具体过程
   - 为发展经济学提供素材

4. **风险溢价之谜探索**（新增）
   - 提出 EPS 低估假说：风险溢价部分来自市场系统性低估盈利增速
   - 用 Shiller 数据 + Gordon 模型进行初步验证
   - 回报归因：无风险利率 4.88% + 合理风险补偿 2.00% + EPS 低估 1.66% + 残余 0.37% = 8.91%
   - 详见 `风险溢价之谜与EPS低估假说.md`

### 实践应用

1. **投资教育**
   - 说明长期投资的重要性
   - 量化时间的风险分散效应
   - 建立理性投资预期

2. **资产配置**
   - 为指数基金投资提供理论支撑
   - 指导退休养老金规划
   - 优化投资组合构建

3. **风险管理**
   - 帮助理解历史波动模式
   - 设定合理的回报预期
   - 指导止损和风险控制

---

## 数据完整性说明

### 数据验证流程

1. **来源多元化**
   - 使用多个权威数据源交叉验证
   - 包括政府机构、学术机构、商业数据库

2. **历史回溯**
   - 1928年数据：追溯至大萧条时期
   - 1999年数据：包括互联网泡沫破裂
   - 2008年数据：包括金融危机
   - 2020年数据：包括COVID-19冲击

3. **异常检查**
   - 极值检查：确认数据在合理范围
   - 连续性检查：相邻年份不存在跳跃
   - 完整性检查：无缺失值

### 已知限制

1. **2020-2024年行业数据**
   - 使用估算映射而非直接数据
   - 精确度可能略低于1927-2019年
   - 结论性分析应主要基于较长历史

2. **成分股数据**
   - 1997年前数据可获得性有限
   - 大部分分析基于1997年起的数据

3. **通胀调整**
   - 使用CPI调整，不考虑其他物价指数（如资产价格）
   - 实际购买力变化可能存在偏差

---

## 项目许可和引用

### 使用许可

本项目数据和分析结果可自由使用，包括：
- 学术研究和论文引用
- 教育机构的教学使用
- 投资报告和分析文档
- 网站和博客转载

### 推荐引用格式

```
S&P 500 Mean Reversion Analysis Project (1928-2024)
Data Sources:
  - S&P 500 Historical Returns
  - U.S. Bureau of Labor Statistics (CPI)
  - Kenneth French Data Library
  - fja05680/sp500 GitHub Repository
Analysis Period: 97 years (1928-2024)
Key Finding: Real CAGR = 6.70% (vs. theoretical 6.8%)
```

### 数据致谢

感谢以下机构提供的数据支持：
- 美国劳工统计局（BLS）
- Kenneth French教授及Dartmouth Tuck商学院
- CRSP（证券价格研究中心）
- fja05680/sp500 GitHub项目维护者

---

## 常见问题

### Q1: 为什么使用1928年作为起点？
**A:** 1928年是现代标普指数的起点，能够提供完整的百年数据。虽然包括了大萧条等极端事件，但这些正是均值回归理论需要验证的场景。

### Q2: 实际CAGR与理论6.8%为什么有差异？
**A:** 差异仅为0.1个百分点（6.70% vs 6.8%），在统计学上完全在置信区间内。这个微小的差异实际上强化了理论的有效性。具体原因可能包括：
- 样本期不同（本项目97年 vs 理论多用100+年数据）
- 通胀调整方法差异
- 股利收益率变化

### Q3: 这个分析能用于预测未来回报吗？
**A:** 不能。历史均值可以作为预期的参考，但未来可能因以下原因而不同：
- 利率环境变化
- 人口结构变化
- 技术进步速度变化
- 全球经济格局变化

### Q4: 为什么要看行业数据？
**A:** 行业数据揭示了指数的内部结构变化。均值回归并非"指数停滞不动"，而是通过不断更新成分股和调整行业权重，实现对经济结构变化的适应。

### Q5: 成分股只有29%存活率是好还是坏？
**A:** 既不好也不坏，而是正常的。这反映了：
- **市场的竞争性**：并非所有公司都能永远领先
- **经济的动态性**：新兴产业不断崛起，传统产业相对衰退
- **指数的自我修复**：通过替换，指数保持对经济前沿的跟踪

---

## 项目更新计划

### 短期（1-3个月）
- [ ] 更新2024年完整年度数据
- [ ] 补充最新的行业权重数据
- [ ] 生成更多细分行业分析

### 中期（3-6个月）
- [ ] 添加不同起点的10年滚动预期回报计算
- [ ] 生成按十年分段的分析报告
- [ ] 构建互动式的"输入年份"获取回报预期
- [ ] 获取 CRSP/Compustat 公司级别数据，修复行业贡献误差
- [ ] 用 I/B/E/S 分析师预测数据验证 EPS 低估假说

### 长期（6-12个月）
- [ ] 扩展至国际市场（英国FTSE、日本Nikkei等）
- [ ] 添加其他资产类别（债券、黄金）对比分析
- [ ] 构建投资组合优化推荐工具
- [ ] 公司级别 EPS/PE 均值回归分析

---

## 开发笔记（踩坑记录）

### 市值加权回报 — 赢家偏差
用年末市值作权重会高估回报（17.71%→10.58%）。必须用**年初（前年12月）市值**作权重。

### Compustat 财年对齐
财年结束月份在1-5月的公司归入前一自然年。用 Compustat `prcc_f`（财年末价格）而非 CRSP 月度价格计算 PE 分解，保持代数恒等式一致。

### PERMNO→GVKEY 映射
用 CCM link table，需检查 `linkdt/linkenddt` 日期有效期和 `linkprim in ['P','C']` 优先级。

### Chart.js 堆叠柱状图隐藏 Bug
混合图表（stacked bar + line）在 canvas 不可见时初始化，bar 数据集会被 `hidden: true`。修复：
1. 每个 dataset 显式设 `hidden: false`
2. chart 创建后 force `getDatasetMeta(i).hidden = null` + `chart.update('none')`
3. scales 加 `stacked: true`

### 分解极值处理
盈利恢复年（2003: +392%, 2009: +116%）因前期盈利趋近零导致分解值极端。图表截断于±100%，用深色标记截断柱，tooltip 显示真实值 + "(capped in chart)"。

### Python f-string + JS 大括号
`rebuild_report.py` 用 Python f-string 生成 JS。`{{` = 字面 `{`，`{var}` = Python 插值，`{{{var}}}` = Python 值嵌入 JS 大括号内。常见错误：`f"{{output_path}}"` 不会插值。

### 环境
- macOS 用 `python3`（无 `python` 别名）
- HTML 报告用 `os.path.join(os.path.dirname(__file__), '..', 'report', ...)` 输出，勿硬编码路径

---

## 支持与反馈

如有问题或建议，欢迎通过以下方式反馈：

### 数据问题
- 联系数据来源提供方（Kenneth French Data Library、BLS等）
- 提供具体年份和指标，便于核实

### 分析逻辑
- 详细描述问题所在
- 提供具体的数据例证
- 建议的改进方向

### 技术问题
- HTML报告显示异常
- 数据计算结果疑问
- 性能或兼容性问题

---

## 项目概览

| 维度 | 说明 |
|------|------|
| **数据跨度** | 97年（1928-2024）指数 + 40年（1985-2024）公司级别 |
| **核心指标** | 实际CAGR = 6.70%（Shiller）；总回报 12.65% = 盈利7.33% + PE2.71% + 股息2.42%（Compustat） |
| **验证结论** | 均值回归成立；20年窗口标准差仅1.89%（收敛4.1倍） |
| **代码行数** | ~3,500行 Python（12个脚本） |
| **数据文件** | 6个JSON + 4个CSV原始数据（CRSP 368MB） |
| **报告大小** | ~4.8MB HTML（内嵌全部数据） |
| **可视化** | 12+个交互式 Chart.js 图表 |
| **数据层级** | 指数 → 行业(11 GICS) → 公司(~500/年, 累计20,437条记录) |

---

**项目完成日期**：2024年
**最后更新**：2025年2月（Phase 3 三层回报分解完成）
**数据更新周期**：年度更新（每年1月）

